<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - {{ movie.title }} - BookNow</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/seat_selection.css') }}">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        .payment-container {
            max-width: 600px;
            margin: 100px auto 50px;
            padding: 30px;
            background: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
        }

        .payment-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--primary-red);
            border-radius: var(--radius-md);
        }

        .payment-header h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .payment-header p {
            color: white;
            opacity: 0.9;
            font-size: 16px;
        }

        .movie-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-light);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .movie-summary img {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .movie-summary-details h3 {
            margin: 0 0 10px 0;
            color: var(--text-dark);
            font-size: 20px;
        }

        .movie-summary-details p {
            margin: 5px 0;
            color: var(--text-dark);
            opacity: 0.7;
            font-size: 14px;
        }

        .payment-details {
            margin-bottom: 30px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            font-size: 16px;
        }

        .payment-row:last-child {
            border-bottom: none;
        }

        .payment-row span:first-child {
            color: var(--text-dark);
            opacity: 0.7;
        }

        .payment-row span:last-child {
            color: var(--text-dark);
            font-weight: 500;
        }

        .payment-row.seats-row span:last-child {
            color: var(--primary-red);
            font-weight: 600;
        }

        .payment-row.total {
            padding: 20px 0;
            margin-top: 10px;
            border-top: 2px solid var(--primary-red);
            font-size: 20px;
            font-weight: 700;
        }

        .payment-row.total span:first-child {
            color: var(--text-dark);
        }

        .payment-row.total span:last-child {
            color: var(--primary-red);
        }

        .pay-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
            color: var(--text-light);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 20px;
        }

        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(230, 57, 70, 0.4);
        }

        .pay-button:active {
            transform: translateY(0);
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--text-dark);
            opacity: 0.7;
            text-decoration: none;
            font-size: 14px;
        }

        .back-link:hover {
            color: var(--primary-red);
            opacity: 1;
        }

        .fee-note {
            font-size: 12px;
            color: var(--text-dark);
            opacity: 0.5;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1><a href="{{ url_for('main.index') }}" class="logo-link">Book<span>Now</span></a></h1>
            </div>
            <ul class="nav-links">
                <li><a href="{{ url_for('main.index') }}">Home</a></li>
                <li><a href="{{ url_for('main.index') }}#movies">Movies</a></li>
            </ul>
            <div class="nav-auth">
                <span class="welcome-text">Welcome, {{ username }}!</span>
            </div>
        </div>
    </nav>

    <!-- Payment Section -->
    <div class="payment-container">
        <div class="payment-header">
            <h1>üéüÔ∏è Payment Summary</h1>
            <p>Review your booking details and proceed with payment</p>
        </div>

        <div class="movie-summary">
            <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
            <div class="movie-summary-details">
                <h3>{{ movie.title }}</h3>
                <p><strong>Theatre:</strong> {{ theatre.name if theatre else 'N/A' }}</p>
                <p><strong>Location:</strong> {{ theatre.city if theatre else '' }}{% if theatre and theatre.state %}, {{ theatre.state }}{% endif %}</p>
                <p><strong>Screen:</strong> {{ screen.name if screen else 'N/A' }}</p>
                <p><strong>Show Date:</strong> {{ showtime.show_date|format_date if showtime else 'N/A' }}</p>
                <p><strong>Show Time:</strong> {{ showtime.show_time|format_time if showtime else 'N/A' }}</p>
            </div>
        </div>

        <div class="payment-details">
            <div class="payment-row seats-row">
                <span>Selected Seats:</span>
                <span>{{ seats|join(', ') }}</span>
            </div>
            <div class="payment-row">
                <span>Number of Tickets:</span>
                <span>{{ seats|length }}</span>
            </div>
            <div class="payment-row">
                <span>Ticket Amount:</span>
                <span>‚Çπ{{ ticket_amount }}</span>
            </div>
            <div class="payment-row">
                <span>Convenience Fee <span class="fee-note">(18% GST included)</span>:</span>
                <span>‚Çπ{{ convenience_fee }}</span>
            </div>
            <div class="payment-row total">
                <span>Total Amount:</span>
                <span>‚Çπ{{ total_amount }}</span>
            </div>
        </div>

        <button class="pay-button" id="payButton">
            üí≥ Pay ‚Çπ{{ total_amount }}
        </button>

        <a href="{{ url_for('booking.book_seats', showtime_id=showtime._id) }}" class="back-link">
            ‚Üê Back to Seat Selection
        </a>
    </div>

    <!-- Data Container -->
    <script id="payment-data" type="application/json">
        {
            "totalAmount": {{ total_amount }},
            "movieId": "{{ movie._id }}",
            "showtimeId": "{{ showtime._id }}",
            "movieTitle": "{{ movie.title }}",
            "seats": {{ seats|tojson }},
            "showDate": "{{ showtime.show_date if showtime else '' }}",
            "showTime": "{{ showtime.show_time if showtime else '' }}",
            "username": "{{ username }}",
            "email": "{{ user_data.email if user_data and user_data.email else '' }}"
        }
    </script>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
        // Load payment data
        const paymentDataElement = document.getElementById('payment-data');
        const paymentData = paymentDataElement ? JSON.parse(paymentDataElement.textContent) : {};

        // Setup event listener for pay button
        document.addEventListener('DOMContentLoaded', function() {
            const payButton = document.getElementById('payButton');
            if (payButton) {
                payButton.addEventListener('click', initiatePayment);
            }
        });

        function initiatePayment() {
            // Create order via API
            fetch('/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: paymentData.totalAmount,
                    showtime_id: paymentData.showtimeId,
                    seats: paymentData.seats
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error creating order: ' + data.error);
                    return;
                }

                // Initialize Razorpay payment
                const options = {
                    key: data.razorpay_key,
                    amount: data.amount,
                    currency: 'INR',
                    name: 'BookNow',
                    description: `Booking for ${paymentData.movieTitle}`,
                    order_id: data.order_id,
                    handler: function(response) {
                        // Verify payment
                        verifyPayment(response, data.booking_data);
                    },
                    prefill: {
                        name: paymentData.username,
                        email: paymentData.email
                    },
                    theme: {
                        color: '#e91e63'
                    }
                };

                const razorpay = new Razorpay(options);
                razorpay.open();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to initiate payment. Please try again.');
            });
        }

        function verifyPayment(response, bookingData) {
            fetch('/verify-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature,
                    booking_data: bookingData
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Redirect to booking confirmation page
                    window.location.href = data.redirect_url;
                } else {
                    alert('Payment verification failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Payment verification failed. Please contact support.');
            });
        }
    </script>
</body>
</html>
