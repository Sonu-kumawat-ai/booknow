<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - {{ movie.title }} - BookNow</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/seat_selection.css') }}">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        .payment-container {
            max-width: 600px;
            margin: 100px auto 50px;
            padding: 30px;
            background: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
        }

        .payment-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--primary-red);
            border-radius: var(--radius-md);
        }

        .payment-header h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .payment-header p {
            color: white;
            opacity: 0.9;
            font-size: 16px;
        }

        .movie-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-light);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .movie-summary img {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .movie-summary-details h3 {
            margin: 0 0 10px 0;
            color: var(--text-dark);
            font-size: 20px;
        }

        .movie-summary-details p {
            margin: 5px 0;
            color: var(--text-dark);
            opacity: 0.7;
            font-size: 14px;
        }

        .payment-details {
            margin-bottom: 30px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            font-size: 16px;
        }

        .payment-row:last-child {
            border-bottom: none;
        }

        .payment-row span:first-child {
            color: var(--text-dark);
            opacity: 0.7;
        }

        .payment-row span:last-child {
            color: var(--text-dark);
            font-weight: 500;
        }

        .payment-row.seats-row span:last-child {
            color: var(--primary-red);
            font-weight: 600;
        }

        .payment-row.total {
            padding: 20px 0;
            margin-top: 10px;
            border-top: 2px solid var(--primary-red);
            font-size: 20px;
            font-weight: 700;
        }

        .payment-row.total span:first-child {
            color: var(--text-dark);
        }

        .payment-row.total span:last-child {
            color: var(--primary-red);
        }

        .pay-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
            color: var(--text-light);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 20px;
        }

        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(230, 57, 70, 0.4);
        }

        .pay-button:active {
            transform: translateY(0);
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--text-dark);
            opacity: 0.7;
            text-decoration: none;
            font-size: 14px;
        }

        .back-link:hover {
            color: var(--primary-red);
            opacity: 1;
        }

        .fee-note {
            font-size: 12px;
            color: var(--text-dark);
            opacity: 0.5;
            font-style: italic;
        }

        /* Offer Section */
        .offer-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--bg-light);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .offer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .offer-header h4 {
            margin: 0;
            color: var(--text-dark);
            font-size: 16px;
        }

        .offer-toggle {
            color: var(--primary-red);
            cursor: pointer;
            font-size: 14px;
            text-decoration: underline;
        }

        .offer-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .offer-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
        }

        .apply-btn {
            padding: 10px 20px;
            background: var(--primary-yellow);
            color: var(--text-dark);
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .apply-btn:hover {
            background: #e0ae2e;
        }

        .offer-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .offer-item {
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .offer-item:hover {
            border-color: var(--primary-red);
            box-shadow: 0 2px 8px rgba(230, 57, 70, 0.1);
        }

        .offer-item.selected {
            border-color: var(--primary-red);
            background: #fff5f5;
        }

        .offer-code {
            font-weight: 600;
            color: var(--primary-red);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .offer-description {
            font-size: 13px;
            color: var(--text-dark);
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .offer-discount {
            font-size: 13px;
            color: var(--primary-red);
            font-weight: 600;
        }

        .applied-offer {
            padding: 12px;
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
        }

        .applied-offer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-offer-btn {
            background: transparent;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
        }

        .offer-message {
            padding: 10px;
            margin-top: 10px;
            border-radius: var(--radius-sm);
            font-size: 14px;
        }

        .offer-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .offer-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .payment-row.discount {
            color: #28a745;
        }

        .payment-row.discount span {
            color: #28a745;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1><a href="{{ url_for('main.index') }}" class="logo-link">Book<span>Now</span></a></h1>
            </div>
            <ul class="nav-links">
                <li><a href="{{ url_for('main.index') }}">Home</a></li>
                <li><a href="{{ url_for('main.all_movies') }}">Movies</a></li>
            </ul>
            <div class="nav-auth">
                <span class="welcome-text">Welcome, {{ username }}!</span>
            </div>
        </div>
    </nav>

    <!-- Payment Section -->
    <div class="payment-container">
        <div class="payment-header">
            <h1>üéüÔ∏è Payment Summary</h1>
            <p>Review your booking details and proceed with payment</p>
        </div>

        <div class="movie-summary">
            <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
            <div class="movie-summary-details">
                <h3>{{ movie.title }}</h3>
                <p><strong>Theatre:</strong> {{ theatre.name if theatre else 'N/A' }}</p>
                <p><strong>Location:</strong> {{ theatre.city if theatre else '' }}{% if theatre and theatre.state %}, {{ theatre.state }}{% endif %}</p>
                <p><strong>Screen:</strong> {{ screen.name if screen else 'N/A' }}</p>
                <p><strong>Show Date:</strong> {{ showtime.show_date|format_date if showtime else 'N/A' }}</p>
                <p><strong>Show Time:</strong> {{ showtime.show_time|format_time if showtime else 'N/A' }}</p>
            </div>
        </div>

        <div class="payment-details">
            <div class="payment-row seats-row">
                <span>Selected Seats:</span>
                <span>{{ seats|join(', ') }}</span>
            </div>
            <div class="payment-row">
                <span>Number of Tickets:</span>
                <span>{{ seats|length }}</span>
            </div>
            <div class="payment-row">
                <span>Ticket Amount:</span>
                <span>‚Çπ{{ ticket_amount }}</span>
            </div>
            <div class="payment-row">
                <span>Convenience Fee <span class="fee-note">(18% GST included)</span>:</span>
                <span>‚Çπ{{ convenience_fee }}</span>
            </div>
            
            <!-- Offers Section -->
            <div class="offer-section">
                <div class="offer-header">
                    <h4>üéÅ Apply Offers</h4>
                    <span class="offer-toggle" id="viewOffersBtn">View All Offers</span>
                </div>
                
                <div id="appliedOfferContainer" style="display: none;">
                    <!-- Applied offer will be shown here -->
                </div>
                
                <div class="offer-input-container">
                    <input type="text" id="offerCodeInput" class="offer-input" placeholder="Enter offer code" />
                    <button class="apply-btn" id="applyOfferBtn">Apply</button>
                </div>
                
                <div id="offerMessage"></div>
                
                <div id="offerListContainer" style="display: none;">
                    <h5 style="margin: 15px 0 10px; font-size: 14px;">Available Offers:</h5>
                    <div class="offer-list" id="offerList">
                        <p style="text-align: center; color: #666;">Loading offers...</p>
                    </div>
                </div>
            </div>
            
            <div id="discountRow" class="payment-row discount" style="display: none;">
                <span>Discount:</span>
                <span id="discountAmount">- ‚Çπ0</span>
            </div>
            
            <div class="payment-row total">
                <span>Total Amount:</span>
                <span id="finalAmount">‚Çπ{{ total_amount }}</span>
            </div>
        </div>

        <button class="pay-button" id="payButton">
            üí≥ Pay <span id="payButtonAmount">‚Çπ{{ total_amount }}</span>
        </button>

        <a href="{{ url_for('booking.book_seats', showtime_id=showtime._id) }}" class="back-link">
            ‚Üê Back to Seat Selection
        </a>
    </div>

    <!-- Data Container -->
    <script id="payment-data" type="application/json">
        {
            "totalAmount": {{ total_amount }},
            "movieId": "{{ movie._id }}",
            "showtimeId": "{{ showtime._id }}",
            "movieTitle": "{{ movie.title }}",
            "seats": {{ seats|tojson }},
            "showDate": "{{ showtime.show_date if showtime else '' }}",
            "showTime": "{{ showtime.show_time if showtime else '' }}",
            "username": "{{ username }}",
            "email": "{{ user_data.email if user_data and user_data.email else '' }}"
        }
    </script>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
        // Load payment data
        const paymentDataElement = document.getElementById('payment-data');
        const paymentData = paymentDataElement ? JSON.parse(paymentDataElement.textContent) : {};
        
        // Offer management variables
        let availableOffers = [];
        let appliedOffer = null;
        let discount = 0;
        let originalAmount = paymentData.totalAmount;
        let finalAmount = originalAmount;

        // Setup event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const payButton = document.getElementById('payButton');
            if (payButton) {
                payButton.addEventListener('click', initiatePayment);
            }
            
            // Offer management listeners
            document.getElementById('viewOffersBtn').addEventListener('click', toggleOfferList);
            document.getElementById('applyOfferBtn').addEventListener('click', applyOfferCode);
            
            // Load available offers
            loadAvailableOffers();
        });
        
        function toggleOfferList() {
            const container = document.getElementById('offerListContainer');
            const btn = document.getElementById('viewOffersBtn');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                btn.textContent = 'Hide Offers';
                if (availableOffers.length === 0) {
                    loadAvailableOffers();
                }
            } else {
                container.style.display = 'none';
                btn.textContent = 'View All Offers';
            }
        }
        
        function loadAvailableOffers() {
            fetch('/get-applicable-offers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    showtime_id: paymentData.showtimeId,
                    amount: originalAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    availableOffers = data.offers;
                    displayOfferList();
                } else {
                    document.getElementById('offerList').innerHTML = '<p style="text-align: center; color: #666;">No offers available</p>';
                }
            })
            .catch(error => {
                console.error('Error loading offers:', error);
                document.getElementById('offerList').innerHTML = '<p style="text-align: center; color: #dc3545;">Failed to load offers</p>';
            });
        }
        
        function displayOfferList() {
            const offerList = document.getElementById('offerList');
            if (availableOffers.length === 0) {
                offerList.innerHTML = '<p style="text-align: center; color: #666;">No offers available for this booking</p>';
                return;
            }
            
            offerList.innerHTML = availableOffers.map(offer => `
                <div class="offer-item" onclick="selectOffer('${offer.code}')">
                    <div class="offer-code">${offer.code}</div>
                    <div class="offer-description">${offer.description}</div>
                    <div class="offer-discount">
                        Save ‚Çπ${offer.calculated_discount} | 
                        ${offer.discount_type === 'percentage' ? offer.discount_value + '% OFF' : '‚Çπ' + offer.discount_value + ' OFF'}
                        ${offer.min_purchase > 0 ? ' (Min: ‚Çπ' + offer.min_purchase + ')' : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function selectOffer(code) {
            document.getElementById('offerCodeInput').value = code;
            applyOfferCode();
        }
        
        function applyOfferCode() {
            const code = document.getElementById('offerCodeInput').value.trim();
            if (!code) {
                showMessage('Please enter an offer code', 'error');
                return;
            }
            
            fetch('/validate-offer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    showtime_id: paymentData.showtimeId,
                    amount: originalAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appliedOffer = data.offer;
                    discount = data.discount;
                    finalAmount = data.final_amount;
                    updatePaymentSummary();
                    showAppliedOffer();
                    showMessage('Offer applied successfully!', 'success');
                    // Hide offer list after applying
                    document.getElementById('offerListContainer').style.display = 'none';
                    document.getElementById('viewOffersBtn').textContent = 'View All Offers';
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error validating offer:', error);
                showMessage('Failed to apply offer. Please try again.', 'error');
            });
        }
        
        function removeOffer() {
            appliedOffer = null;
            discount = 0;
            finalAmount = originalAmount;
            updatePaymentSummary();
            document.getElementById('appliedOfferContainer').style.display = 'none';
            document.getElementById('offerCodeInput').value = '';
            showMessage('Offer removed', 'success');
        }
        
        function showAppliedOffer() {
            const container = document.getElementById('appliedOfferContainer');
            container.innerHTML = `
                <div class="applied-offer">
                    <div class="applied-offer-header">
                        <div>
                            <strong>${appliedOffer.code}</strong> applied!
                            <div style="font-size: 12px; color: #155724; margin-top: 3px;">
                                You saved ‚Çπ${discount}
                            </div>
                        </div>
                        <button class="remove-offer-btn" onclick="removeOffer()">Remove</button>
                    </div>
                </div>
            `;
            container.style.display = 'block';
        }
        
        function updatePaymentSummary() {
            const discountRow = document.getElementById('discountRow');
            const discountAmount = document.getElementById('discountAmount');
            const finalAmountEl = document.getElementById('finalAmount');
            const payButtonAmount = document.getElementById('payButtonAmount');
            
            if (discount > 0) {
                discountRow.style.display = 'flex';
                discountAmount.textContent = `- ‚Çπ${discount}`;
            } else {
                discountRow.style.display = 'none';
            }
            
            finalAmountEl.textContent = `‚Çπ${finalAmount}`;
            payButtonAmount.textContent = `‚Çπ${finalAmount}`;
            
            // Update payment data
            paymentData.totalAmount = finalAmount;
            paymentData.discount = discount;
            paymentData.appliedOfferCode = appliedOffer ? appliedOffer.code : null;
            paymentData.appliedOfferId = appliedOffer ? appliedOffer._id : null;
        }
        
        function showMessage(message, type) {
            const messageDiv = document.getElementById('offerMessage');
            messageDiv.innerHTML = `<div class="offer-message ${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        function initiatePayment() {
            // Create order via API with discount info
            fetch('/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: paymentData.totalAmount,
                    showtime_id: paymentData.showtimeId,
                    seats: paymentData.seats,
                    offer_code: paymentData.appliedOfferCode,
                    discount: paymentData.discount,
                    original_amount: originalAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error creating order: ' + data.error);
                    return;
                }

                // Initialize Razorpay payment
                const options = {
                    key: data.razorpay_key,
                    amount: data.amount,
                    currency: 'INR',
                    name: 'BookNow',
                    description: `Booking for ${paymentData.movieTitle}`,
                    order_id: data.order_id,
                    handler: function(response) {
                        // Verify payment
                        verifyPayment(response, data.booking_data);
                    },
                    prefill: {
                        name: paymentData.username,
                        email: paymentData.email
                    },
                    theme: {
                        color: '#e91e63'
                    }
                };

                const razorpay = new Razorpay(options);
                razorpay.open();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to initiate payment. Please try again.');
            });
        }

        function verifyPayment(response, bookingData) {
            fetch('/verify-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature,
                    booking_data: bookingData
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Redirect to booking confirmation page
                    window.location.href = data.redirect_url;
                } else {
                    alert('Payment verification failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Payment verification failed. Please contact support.');
            });
        }
    </script>
</body>
</html>
